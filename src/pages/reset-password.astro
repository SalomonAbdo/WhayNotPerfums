---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Restablecer Contraseña | Why Not Perfums">
    <div class="min-h-[60vh] flex flex-col justify-center py-12 sm:px-6 lg:px-8 bg-gray-50">
        <div class="sm:mx-auto sm:w-full sm:max-w-md">
            <h2 class="mt-6 text-center text-3xl font-serif font-bold tracking-tight text-brand-dark">
                Restablecer Contraseña
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                Ingresa tu nueva contraseña a continuación.
            </p>
        </div>

        <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
            <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10 border border-gray-100">

                <!-- Estado: Verificando código -->
                <div id="verifying-code" class="text-center py-4">
                    <svg class="animate-spin h-8 w-8 text-brand-dark mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-500">Verificando enlace...</p>
                </div>

                <!-- Estado: Error de código -->
                <div id="code-error" class="hidden text-center py-4">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                        <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">Enlace inválido o expirado</h3>
                    <p class="mt-2 text-sm text-gray-500">
                        El enlace para restablecer la contraseña no es válido o ha expirado. Por favor solicita uno nuevo.
                    </p>
                    <div class="mt-6">
                        <a href="/" class="text-brand-accent hover:text-brand-dark font-medium">
                            Volver al inicio
                        </a>
                    </div>
                </div>

                <!-- Formulario de Cambio -->
                <form id="reset-password-form" class="hidden space-y-6">
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label>
                        <div class="mt-1">
                            <input id="new-password" name="new-password" type="password" required class="block w-full border-0 py-3 px-4 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-brand-accent sm:text-sm sm:leading-6 rounded-lg">
                        </div>
                    </div>

                    <div>
                        <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label>
                        <div class="mt-1">
                            <input id="confirm-new-password" name="confirm-new-password" type="password" required class="block w-full border-0 py-3 px-4 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-brand-accent sm:text-sm sm:leading-6 rounded-lg">
                        </div>
                        <p id="password-match-error" class="mt-2 text-sm text-red-600 hidden">Las contraseñas no coinciden</p>
                    </div>

                    <div>
                        <button type="submit" class="flex w-full justify-center bg-brand-dark px-4 py-3 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-gray-800 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-dark uppercase tracking-widest transition-colors rounded-lg">
                            Cambiar Contraseña
                        </button>
                    </div>
                </form>

                <!-- Estado: Éxito -->
                <div id="success-view" class="hidden text-center py-4">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                        <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">¡Contraseña restablecida!</h3>
                    <p class="mt-2 text-sm text-gray-500">
                        Tu contraseña ha sido actualizada correctamente. Ya puedes iniciar sesión con tu nueva credencial.
                    </p>
                    <div class="mt-6">
                        <button id="open-login-btn" class="w-full flex justify-center bg-brand-dark px-4 py-2 text-sm font-bold text-white shadow-sm hover:bg-gray-800 rounded-lg uppercase tracking-wide">
                            Iniciar Sesión
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</Layout>

<script>
    import { auth } from '../firebase/client';
    import { verifyPasswordResetCode, confirmPasswordReset } from "firebase/auth";

    const searchParams = new URL(window.location.href).searchParams;
    const oobCode = searchParams.get('oobCode');
    const mode = searchParams.get('mode');

    const VerifyView = document.getElementById('verifying-code');
    const ErrorView = document.getElementById('code-error');
    const FormView = document.getElementById('reset-password-form');
    const SuccessView = document.getElementById('success-view');
    const PasswordMatchError = document.getElementById('password-match-error');

    // Manejo de UI
    const showView = (viewId) => {
        [VerifyView, ErrorView, FormView, SuccessView].forEach(el => {
            if(el) el.classList.add('hidden');
        });
        const el = document.getElementById(viewId);
        if(el) el.classList.remove('hidden');
    }

    // Inicialización
    async function init() {
        if (!oobCode || mode !== 'resetPassword') {
            showView('code-error');
            return;
        }

        try {
            // Verificar si el código es válido
            const email = await verifyPasswordResetCode(auth, oobCode);
            console.log("Código válido para:", email);

            // Si es válido, mostrar formulario
            // (Para ser más limpio, ocultamos 'verifying' y mostramos 'form')
            if (VerifyView) VerifyView.classList.add('hidden');
            if (FormView) FormView.classList.remove('hidden');

        } catch (error) {
            console.error("Link inválido:", error);
            showView('code-error');
        }
    }

    init();

    // Lógica del formulario
    if (FormView) {
        const passwordInput = document.getElementById('new-password') as HTMLInputElement;
        const confirmInput = document.getElementById('confirm-new-password') as HTMLInputElement;

        FormView.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (passwordInput.value !== confirmInput.value) {
                if(PasswordMatchError) PasswordMatchError.classList.remove('hidden');
                return;
            } else {
                if(PasswordMatchError) PasswordMatchError.classList.add('hidden');
            }

            if (!oobCode) return;

            try {
                // Cambiar contraseña en Firebase
                await confirmPasswordReset(auth, oobCode, passwordInput.value);
                showView('success-view');
            } catch (error) {
                console.error("Error al restablecer:", error);
                alert("Hubo un error al actualizar la contraseña: " + error.message);
            }
        });

        // Limpiar error al escribir
        confirmInput.addEventListener('input', () => {
             if(PasswordMatchError) PasswordMatchError.classList.add('hidden');
        });
    }

    // Botón Iniciar Sesión al finalizar
    const openLoginBtn = document.getElementById('open-login-btn');
    if (openLoginBtn) {
        openLoginBtn.addEventListener('click', () => {
            window.location.href = '/?login=true';
        });
    }

    // Verificar si venimos de un reset exitoso para abrir modal en home
    // (Esto es opcional si redirigimos a home, pero aquí estamos redirigiendo con query param)
</script>

